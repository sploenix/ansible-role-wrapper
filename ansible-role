#!/usr/bin/env python3

import sys
import os
from sh import ansible_galaxy, grep, sed
import pty
import tempfile
from argparse import ArgumentParser

parser = ArgumentParser(description="Run ansible role in collection")
parser.add_argument("fqcn",
                    help="Fully qualified collection name (namespace.collection.role)")
parser.add_argument("ansible_args",
                    help="Arguments for ansible-playbook",
                    nargs="*",
                    type=str)
parser.add_argument('--debug',
                    default=False,
                    action='store_true')

# Ansible args are not parsed correctly by argparse
# so we need to replace parameter starting with - and -- with DELMINUS
i = 0
for i in range(len(sys.argv[2:])):
    arg = sys.argv[i + 2]
    if arg[0] == "-":
        if arg[1] == "-":
            sys.argv[i + 2] = sys.argv[i + 2][0] + 'DELMINUS' + sys.argv[i + 2][2:]
        sys.argv[i + 2] = 'DELMINUS' + sys.argv[i + 2][1:]
    i += 1

# parse arguments
ARGS = parser.parse_args()

# replace DELMINUS with -
i = 0
for i in range(len(ARGS.ansible_args)):
    ARGS.ansible_args[i] = ARGS.ansible_args[i].replace("DELMINUS", "-")
    i += 1


class Playbook:
    tmpfile = None
    name = None

    def __init__(self, fqcn):
        self.tmpfile = tempfile.NamedTemporaryFile(suffix='.yml', prefix='ansible-role-playbook')
        self.name = self.tmpfile.name
        fhandle = open(self.name, "w")
        fhandle.write(f"---\n")
        fhandle.write(f"- name: temporary playbook for role {fqcn} generated by ansible-role wrapper\n")
        fhandle.write("  hosts: all\n")
        fhandle.write("  roles:\n")
        fhandle.write(f"    - {fqcn}\n")
        fhandle.close()

    def run(self, playbook_args):
        if ARGS.debug:
            args = " ".join(playbook_args)
            print(f'Run "ansible-playbook {self.name} {args}"')

        # run ansible-playbook in pty (to get colours and live output)
        def read(fd):
            data = os.read(fd, 1024)
            return data

        cmd = ["ansible-playbook", self.name] + playbook_args
        pty.spawn(cmd, read)


def get_collection_dir(namespace_collection):
    if not ansible_galaxy("collection", "list", f"{namespace_collection}"):
        print(f"Collection {namespace_collection} not found - exit!")
        exit(1)
    else:
        collection_basedir = sed(grep(ansible_galaxy("collection", "list", f"{namespace_collection}"), "# /"), "s/# //")
    collection_basedir = collection_basedir.replace("\n", "")
    collection_dir = f'{collection_basedir}/{namespace_collection.replace(".", "/")}'
    return collection_dir


def parse_ansible_fqcn():
    # check fqcn syntax
    fqcn = ARGS.fqcn
    if fqcn.count(".") != 2:
        print("Invalid ansible role syntax - exit!")
        print(f'{fqcn} != namespace.collection.role')
        exit(1)

    # split namespace.collection from fqcn
    namespace_collection = ".".join(fqcn.split(".")[0:2])
    role_name = fqcn.split(".")[2]

    # get local directory for collection
    collection_dir = get_collection_dir(namespace_collection)

    if ARGS.debug:
        print(f"Found collection: {collection_dir}")

    # check if collection contains role
    if not os.path.isdir(f"{collection_dir}/roles/{role_name}"):
        print(f"Collection {namespace_collection} does not contain role {role_name} - exit!")
        exit(1)

    if ARGS.debug:
        print(f"Found role {collection_dir}/roles/{role_name}")


def main():
    parse_ansible_fqcn()

    # generate temporary playbook and run it
    Playbook(ARGS.fqcn).run(ARGS.ansible_args)

    return 0


if __name__ == "__main__":
    sys.exit(main())
